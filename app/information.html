<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Match Analysis Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }
    
    .main-container {
      display: flex;
      min-height: 100vh;
    }
    
    .left-panel {
      width: 40%;
      padding: 30px;
      overflow-y: auto;
      background-color: #f8f9fa;
    }
    
    .right-panel {
      width: 60%;
      padding: 30px;
      overflow-y: auto;
    }
    
    .chart-container {
      width: 100%;
      height: 500px;
      margin-bottom: 40px;
      position: relative;
    }
    
    .chart-container.large {
      height: 600px;
    }
    
    .chart-title {
      text-align: center;
      margin-bottom: 15px;
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .chart-subtitle {
      text-align: center;
      margin-bottom: 30px;
      font-size: 16px;
      color: #666;
    }
    
    .controls-panel {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .control-label {
      font-weight: bold;
      font-size: 12px;
      color: #333;
    }
    
    .control-select {
      padding: 6px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 12px;
    }
    
    .team-comparison {
      max-height: 300px;
      overflow-y: auto;
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .team-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px;
      border-bottom: 1px solid #eee;
    }
    
    .team-name {
      font-weight: bold;
      color: #333;
      font-size: 14px;
    }
    
    .team-stats {
      font-size: 11px;
      color: #666;
    }
    
    .shot-map-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 15px;
    }
    
    .shot-location {
      background: #f8f9fa;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      border: 2px solid transparent;
      transition: border-color 0.3s;
    }
    
    .shot-location:hover {
      border-color: #007bff;
    }
    
    .location-name {
      font-weight: bold;
      font-size: 11px;
      margin-bottom: 3px;
    }
    
    .location-stats {
      font-size: 9px;
      color: #666;
    }
    
    .generate-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-top: 40px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .generate-input {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 6px;
      outline: none;
      transition: border-color 0.3s;
    }
    
    .generate-input:focus {
      border-color: #007bff;
    }
    
    .generate-input::placeholder {
      color: #999;
      font-style: italic;
    }
    
    .generate-btn {
      padding: 15px 30px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background: #222;
      color: white;
      border-radius: 6px;
      font-weight: bold;
    }
    
    .generate-btn:hover {
      background: #444;
    }
    
    .visualization-selector {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }
    
    .selector-label {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 15px;
      color: #333;
    }
    
    .selector-dropdown {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 6px;
      background: white;
      cursor: pointer;
    }
    
    .selector-dropdown:focus {
      border-color: #007bff;
      outline: none;
    }
    
    .loading {
      text-align: center;
      color: #666;
      font-style: italic;
    }
    
    .error {
      text-align: center;
      color: #e74c3c;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <div class="main-container">
    <div class="left-panel">
    <h2>Soccer Match Analysis Dashboard</h2>
    <p>This comprehensive dashboard provides detailed analysis of previous soccer matches, breaking down every play to help coaches and analysts understand team performance patterns.</p>
    
    <h3>Available Visualizations:</h3>
    
    <h4>üéØ Goals Timeline Analysis</h4>
    <p>Interactive scatter plot showing when goals are scored throughout matches. Each team is color-coded distinctly, displaying minute vs expected goals (xG) to reveal scoring patterns and timing trends.</p>
    
    <h4>üìä Distance vs Expected Goals</h4>
    <p>Correlation analysis between shot distance and expected goals. Shows how shot quality varies with distance from goal, helping identify optimal shooting positions.</p>
    
    <h4>‚è∞ Match Minute vs Success Rate</h4>
    <p>Success rate analysis by match periods. Groups shots into 10-minute ranges to show how performance changes throughout the game - revealing when teams are most effective.</p>
    
    <h4>üó∫Ô∏è Shot Map Analysis</h4>
    <p>Location-based performance breakdown showing where shots originate on the field. Displays success rates, total shots, goals, and average xG for each field position.</p>
    
    <h4>üë• Team Comparison</h4>
    <p>Quick overview comparing performance across all opponents with key metrics including games played, goals scored, and conversion rates.</p>
  </div>

  <div class="right-panel">
    <div class="visualization-selector">
      <div class="selector-label">Select Visualization:</div>
      <select id="visualizationSelect" class="selector-dropdown">
        <option value="goalsTimeline">üéØ Goals Timeline Analysis</option>
        <option value="scatterMatrix">üìä Advanced Scatter Plot Matrix</option>
        <option value="shotMap">üó∫Ô∏è Shot Map Analysis</option>
        <option value="teamComparison">üë• Team Comparison</option>
      </select>
    </div>

    <div id="goalsTimelineSection" class="visualization-section">
      <div class="chart-title">Goals Timeline Analysis</div>
      <div class="chart-subtitle">When and how goals are scored across all matches</div>
      
      <div class="controls-panel">
        <div class="control-group">
          <label class="control-label">Opponent:</label>
          <select id="opponentFilter" class="control-select">
            <option value="all">All Opponents</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Play Context:</label>
          <select id="contextFilter" class="control-select">
            <option value="all">All Contexts</option>
          </select>
        </div>
      </div>

      <div class="chart-container large">
        <canvas id="goalsTimelineChart"></canvas>
      </div>
    </div>

    <div id="scatterMatrixSection" class="visualization-section" style="display: none;">
      <div class="chart-title">Advanced Scatter Plot Matrix</div>
      <div class="chart-subtitle">Multiple correlation analyses with interactive filtering</div>
      
      <div class="controls-panel">
        <div class="control-group">
          <label class="control-label">Opponent:</label>
          <select id="matrixOpponentFilter" class="control-select">
            <option value="all">All Opponents</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Game Phase:</label>
          <select id="matrixPhaseFilter" class="control-select">
            <option value="all">All Phases</option>
          </select>
        </div>
        <div class="control-group">
          <label class="control-label">Play Context:</label>
          <select id="matrixContextFilter" class="control-select">
            <option value="all">All Contexts</option>
          </select>
        </div>
      </div>

      <div class="chart-title">Distance vs Expected Goals (xG)</div>
      <div class="chart-subtitle">Correlation between shot distance and expected goals</div>
      <div class="chart-container">
        <canvas id="distanceXGChart"></canvas>
      </div>

      <div class="chart-title">Match Minute vs Success Rate</div>
      <div class="chart-subtitle">Success rate analysis by match periods</div>
      <div class="chart-container">
        <canvas id="minuteSuccessChart"></canvas>
      </div>
    </div>

    <div id="teamComparisonSection" class="visualization-section" style="display: none;">
      <div class="chart-title">Team Comparison</div>
      <div class="chart-subtitle">Performance comparison across all opponents</div>
      <div class="team-comparison" id="teamComparisonDropdown">
        <div class="loading">Loading team data...</div>
      </div>
    </div>

    <div id="shotMapSection" class="visualization-section" style="display: none;">
      <div class="chart-title">Shot Map - Location Analysis</div>
      <div class="chart-subtitle">Performance by field location</div>
      <div class="shot-map-grid" id="shotMap">
        <div class="loading">Loading shot map...</div>
      </div>
    </div>

    <div class="generate-section">
      <input type="text" class="generate-input" placeholder="Generate predictions for play based on match data">
      <button class="generate-btn">Generate Prediction</button>
    </div>
  </div>
  </div>

  <script>
    let goalsTimelineChart;
    let distanceXGChart;
    let minuteSuccessChart;
    let comprehensiveData;

    async function loadComprehensiveData() {
      try {
        const response = await fetch('/api/comprehensive-data');
        comprehensiveData = await response.json();
        
        populateTeamComparisonDropdown();
        populateShotMap();
        populateFilters();
        populateMatrixFilters();
        renderGoalsTimeline();
        renderDistanceXGChart();
        renderMinuteSuccessChart();
        
      } catch (error) {
        console.error('Error loading comprehensive data:', error);
        document.querySelector('.right-panel').innerHTML = 
          '<div class="error">Error loading comprehensive data. Please check if the server is running.</div>';
      }
    }

    function populateTeamComparisonDropdown() {
      const container = document.getElementById('teamComparisonDropdown');
      const teams = Object.keys(comprehensiveData.teamComparison);
      
      container.innerHTML = teams.map(team => {
        const stats = comprehensiveData.teamComparison[team];
        return `
          <div class="team-item">
            <div class="team-name">${team}</div>
            <div class="team-stats">
              ${stats.gamesPlayed} games<br>
              ${stats.totalGoals} goals<br>
              ${stats.conversionRate.toFixed(1)}% conv.
            </div>
          </div>
        `;
      }).join('');
    }

    function populateShotMap() {
      const container = document.getElementById('shotMap');
      const locations = Object.keys(comprehensiveData.shotMapData);
      
      container.innerHTML = locations.map(location => {
        const data = comprehensiveData.shotMapData[location];
        return `
          <div class="shot-location">
            <div class="location-name">${location}</div>
            <div class="location-stats">
              ${data.totalShots} shots<br>
              ${data.goals} goals<br>
              ${data.successRate.toFixed(1)}% success<br>
              ${data.avgXG.toFixed(2)} avg xG
            </div>
          </div>
        `;
      }).join('');
    }

    function populateFilters() {
      // Populate opponent filter
      const opponentFilter = document.getElementById('opponentFilter');
      const opponents = [...new Set(comprehensiveData.goalsTimeline.map(goal => goal.opponent))];
      opponents.forEach(opponent => {
        const option = document.createElement('option');
        option.value = opponent;
        option.textContent = opponent;
        opponentFilter.appendChild(option);
      });

      // Populate context filter
      const contextFilter = document.getElementById('contextFilter');
      const contexts = [...new Set(comprehensiveData.goalsTimeline.map(goal => goal.playContext))];
      contexts.forEach(context => {
        const option = document.createElement('option');
        option.value = context;
        option.textContent = context;
        contextFilter.appendChild(option);
      });
    }

    function populateMatrixFilters() {
      // Populate matrix opponent filter
      const matrixOpponentFilter = document.getElementById('matrixOpponentFilter');
      const opponents = [...new Set(comprehensiveData.games.map(game => game.opponent))];
      opponents.forEach(opponent => {
        const option = document.createElement('option');
        option.value = opponent;
        option.textContent = opponent;
        matrixOpponentFilter.appendChild(option);
      });

      // Populate matrix phase filter
      const matrixPhaseFilter = document.getElementById('matrixPhaseFilter');
      const phases = ['Early', 'Middle', 'Late'];
      phases.forEach(phase => {
        const option = document.createElement('option');
        option.value = phase;
        option.textContent = phase;
        matrixPhaseFilter.appendChild(option);
      });

      // Populate matrix context filter
      const matrixContextFilter = document.getElementById('matrixContextFilter');
      const contexts = [...new Set(comprehensiveData.games.flatMap(game => 
        game.plays.map(play => play.playContext)
      ).filter(context => context))];
      contexts.forEach(context => {
        const option = document.createElement('option');
        option.value = context;
        option.textContent = context;
        matrixContextFilter.appendChild(option);
      });
    }

    function renderGoalsTimeline() {
      const ctx = document.getElementById('goalsTimelineChart').getContext('2d');
      
      // Destroy existing chart
      if (goalsTimelineChart) {
        goalsTimelineChart.destroy();
      }

      const selectedOpponent = document.getElementById('opponentFilter').value;
      const selectedContext = document.getElementById('contextFilter').value;
      
      let filteredGoals = comprehensiveData.goalsTimeline;
      if (selectedOpponent !== 'all') {
        filteredGoals = filteredGoals.filter(goal => goal.opponent === selectedOpponent);
      }
      if (selectedContext !== 'all') {
        filteredGoals = filteredGoals.filter(goal => goal.playContext === selectedContext);
      }

      // Create scatter plot data with xG as Y-axis instead of fixed 1
      const datasets = {};
      
      filteredGoals.forEach(goal => {
        if (!datasets[goal.opponent]) {
          datasets[goal.opponent] = [];
        }
        datasets[goal.opponent].push({
          x: goal.minute,
          y: goal.xG, // Use xG as Y-axis for proper scatter plot
          opponent: goal.opponent,
          playType: goal.playType,
          playContext: goal.playContext,
          location: goal.location,
          xG: goal.xG,
          winImpact: goal.winImpact
        });
      });

      // Create 20 distinct colors for each team
      const colors = [
        'rgba(255, 99, 132, 0.8)',   // Red
        'rgba(54, 162, 235, 0.8)',   // Blue
        'rgba(255, 205, 86, 0.8)',   // Yellow
        'rgba(75, 192, 192, 0.8)',   // Teal
        'rgba(153, 102, 255, 0.8)',  // Purple
        'rgba(255, 159, 64, 0.8)',   // Orange
        'rgba(199, 199, 199, 0.8)',  // Gray
        'rgba(83, 102, 255, 0.8)',   // Indigo
        'rgba(255, 99, 255, 0.8)',   // Pink
        'rgba(99, 255, 132, 0.8)',   // Green
        'rgba(255, 132, 99, 0.8)',   // Coral
        'rgba(132, 99, 255, 0.8)',   // Violet
        'rgba(255, 193, 7, 0.8)',    // Amber
        'rgba(40, 167, 69, 0.8)',    // Success Green
        'rgba(220, 53, 69, 0.8)',    // Danger Red
        'rgba(23, 162, 184, 0.8)',   // Info Cyan
        'rgba(108, 117, 125, 0.8)',  // Secondary Gray
        'rgba(102, 16, 242, 0.8)',   // Primary Purple
        'rgba(253, 126, 20, 0.8)',   // Warning Orange
        'rgba(32, 201, 151, 0.8)'    // Success Teal
      ];

      const chartDatasets = Object.keys(datasets).map((opponent, index) => ({
        label: opponent,
        data: datasets[opponent],
        backgroundColor: colors[index % colors.length],
        borderColor: colors[index % colors.length].replace('0.8', '1'),
        pointRadius: 6,
        pointHoverRadius: 8
      }));

      goalsTimelineChart = new Chart(ctx, {
        type: 'scatter',
        data: { datasets: chartDatasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: {
              display: true,
              text: 'Goals Timeline - Minute vs Expected Goals'
            },
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                title: function(context) {
                  const point = context[0].raw;
                  return `${point.opponent} - Minute ${point.x}`;
                },
                label: function(context) {
                  const point = context[0].raw;
                  return [
                    `Play Type: ${point.playType}`,
                    `Context: ${point.playContext}`,
                    `Location: ${point.location}`,
                    `xG: ${point.xG.toFixed(2)}`,
                    `Win Impact: ${point.winImpact}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Match Minute'
              },
              min: 0,
              max: 90
            },
            y: {
              title: {
                display: true,
                text: 'Expected Goals (xG)'
              },
              min: 0
            }
          }
        }
      });
    }

    function getFilteredMatrixData() {
      const selectedOpponent = document.getElementById('matrixOpponentFilter').value;
      const selectedPhase = document.getElementById('matrixPhaseFilter').value;
      const selectedContext = document.getElementById('matrixContextFilter').value;
      
      let filteredGames = comprehensiveData.games;
      if (selectedOpponent !== 'all') {
        filteredGames = filteredGames.filter(game => game.opponent === selectedOpponent);
      }
      
      let allPlays = filteredGames.flatMap(game => game.plays);
      
      if (selectedPhase !== 'all') {
        allPlays = allPlays.filter(play => play.phaseOfMatch === selectedPhase);
      }
      
      if (selectedContext !== 'all') {
        allPlays = allPlays.filter(play => play.playContext === selectedContext);
      }
      
      return allPlays;
    }

    function renderDistanceXGChart() {
      const ctx = document.getElementById('distanceXGChart').getContext('2d');
      
      if (distanceXGChart) {
        distanceXGChart.destroy();
      }

      const shotData = getFilteredMatrixData().filter(play => 
        play.shotAttempt === 'Yes' && play.shotDistance && play.xG > 0
      );

      distanceXGChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Shots',
            data: shotData.map(shot => ({
              x: shot.shotDistance,
              y: shot.xG,
              outcome: shot.shotOutcome,
              playType: shot.playType,
              context: shot.playContext,
              location: shot.location,
              opponent: shot.opponent || 'Unknown'
            })),
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                title: function(context) {
                  const point = context[0].raw;
                  return `${point.playType} - ${point.outcome}`;
                },
                label: function(context) {
                  const point = context[0].raw;
                  return [
                    `Distance: ${point.x} yards`,
                    `xG: ${point.y.toFixed(2)}`,
                    `Context: ${point.context}`,
                    `Location: ${point.location}`,
                    `Opponent: ${point.opponent}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Shot Distance (yards)'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Expected Goals (xG)'
              }
            }
          }
        }
      });
    }

    function renderMinuteSuccessChart() {
      const ctx = document.getElementById('minuteSuccessChart').getContext('2d');
      
      if (minuteSuccessChart) {
        minuteSuccessChart.destroy();
      }

      const shotData = getFilteredMatrixData().filter(play => play.shotAttempt === 'Yes');

      // Group by minute ranges and calculate success rates
      const minuteRanges = {};
      shotData.forEach(play => {
        const range = Math.floor(play.minute / 10) * 10; // 10-minute ranges
        if (!minuteRanges[range]) {
          minuteRanges[range] = { total: 0, successful: 0 };
        }
        minuteRanges[range].total++;
        if (play.shotOutcome === 'Goal') {
          minuteRanges[range].successful++;
        }
      });

      const minuteSuccessData = Object.keys(minuteRanges).map(range => ({
        x: parseInt(range) + 5, // Center of range
        y: (minuteRanges[range].successful / minuteRanges[range].total) * 100,
        total: minuteRanges[range].total,
        successful: minuteRanges[range].successful
      }));

      minuteSuccessChart = new Chart(ctx, {
        type: 'scatter',
        data: {
          datasets: [{
            label: 'Success Rate by Minute',
            data: minuteSuccessData,
            backgroundColor: 'rgba(255, 99, 132, 0.6)',
            borderColor: 'rgba(255, 99, 132, 1)',
            pointRadius: 6,
            pointHoverRadius: 8
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            tooltip: {
              callbacks: {
                title: function(context) {
                  const point = context[0].raw;
                  return `Minute ${point.x} Range`;
                },
                label: function(context) {
                  const point = context[0].raw;
                  return [
                    `Success Rate: ${point.y.toFixed(1)}%`,
                    `Total Shots: ${point.total}`,
                    `Successful: ${point.successful}`
                  ];
                }
              }
            }
          },
          scales: {
            x: {
              title: {
                display: true,
                text: 'Match Minute'
              },
              min: 0,
              max: 90
            },
            y: {
              title: {
                display: true,
                text: 'Success Rate (%)'
              },
              min: 0,
              max: 100
            }
          }
        }
      });
    }

    function showVisualization(visualization) {
      // Hide all sections
      document.querySelectorAll('.visualization-section').forEach(section => {
        section.style.display = 'none';
      });
      
      // Show selected section
      document.getElementById(visualization + 'Section').style.display = 'block';
    }

    // Event listeners for filtering
    document.getElementById('opponentFilter').addEventListener('change', renderGoalsTimeline);
    document.getElementById('contextFilter').addEventListener('change', renderGoalsTimeline);
    
    // Event listeners for matrix filtering
    document.getElementById('matrixOpponentFilter').addEventListener('change', function() {
      renderDistanceXGChart();
      renderMinuteSuccessChart();
    });
    document.getElementById('matrixPhaseFilter').addEventListener('change', function() {
      renderDistanceXGChart();
      renderMinuteSuccessChart();
    });
    document.getElementById('matrixContextFilter').addEventListener('change', function() {
      renderDistanceXGChart();
      renderMinuteSuccessChart();
    });
    
    // Event listener for visualization selector
    document.getElementById('visualizationSelect').addEventListener('change', function() {
      showVisualization(this.value);
    });

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', loadComprehensiveData);
  </script>

</body>
</html>
